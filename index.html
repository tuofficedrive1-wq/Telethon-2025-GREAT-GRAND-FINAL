<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telethone 2025 Live Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bowlby+One+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <!-- html2canvas for poster download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        /* Custom CSS for top 3 rows highlight animation */
        .highlight-pulse {
            animation: pulse-ring 0.6s cubic-bezier(0, 0, 0.2, 1) forwards;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.4);
            }
            100% {
                transform: scale(1.02);
                box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
            }
        }

        /* Custom CSS for Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Blue 500 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* NEW: Custom CSS for smooth transitions on rank items */
        .rank-item {
            /* Smooth transition for position changes */
            transition: all 0.5s ease-in-out;
            will-change: transform, box-shadow;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="root"></div>
    <!-- This div is for rendering the poster off-screen before download -->
    <div id="poster-container" style={{ position: 'absolute', left: '-9999px', top: 0 }}></div>


    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- Utility Functions for Formatting and Animation ---

        // Formatter for Currency
        const formatCurrency = (amount) => {
            // Round to nearest integer for clean animation and display
            return 'â‚¹ ' + new Intl.NumberFormat('en-IN').format(Math.round(amount));
        };

        // Formatter for Unit (Used for individual class units, and Overall Rank)
        const formatUnit = (amount) => {
             if (typeof amount !== 'number' || amount < 0) return "0.0";
             const units = amount / 7000; // Apply the new logic
             return units.toFixed(1); // Show exactly 1 decimal place
        }

        // Formatter for Overall Rank Units (Kept for clarity, but logic is same as formatUnit)
        const formatOverallUnit = (amount) => {
             if (typeof amount !== 'number' || amount < 0) return "0.0";
             const units = amount / 7000;
             return units.toFixed(1); // Show exactly 1 decimal place
        }


        // Component for smooth number animation
        const AnimatedNumber = ({ value, duration = 1500, formatter }) => {
            const [displayValue, setDisplayValue] = useState(value);
            const previousValueRef = useRef(value);

            useEffect(() => {
                let startTimestamp;
                const startValue = previousValueRef.current || 0;
                const endValue = value || 0;
                
                if (endValue === startValue) {
                    setDisplayValue(endValue);
                    return;
                }

                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const elapsed = timestamp - startTimestamp;
                    const progress = Math.min(1, elapsed / duration);
                    const easedProgress = 1 - Math.pow(1 - progress, 3); 
                    const currentValue = startValue + (endValue - startValue) * easedProgress;
                    setDisplayValue(currentValue);

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        setDisplayValue(endValue); 
                    }
                };

                const animationFrameId = requestAnimationFrame(step);

                return () => {
                    cancelAnimationFrame(animationFrameId);
                    previousValueRef.current = endValue; 
                };
            }, [value, duration]);

            useEffect(() => {
                previousValueRef.current = value;
            }, [value]);


            return <span>{formatter(displayValue)}</span>;
        };
        
        // --- Live Clock Component ---
        const LiveClock = () => {
            const [time, setTime] = useState(new Date());

            useEffect(() => {
                const timerId = setInterval(() => {
                    setTime(new Date());
                }, 1000);

                return () => clearInterval(timerId);
            }, []);

            return (
                <div className="text-sm font-medium text-slate-600 bg-slate-200 px-3 py-1 rounded-lg shadow-inner">
                    {time.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}
                </div>
            );
        };
        
        // --- Google Sheet Configuration and Logic ---
        
        const DEFAULT_SHEET_CONFIGS = {
            "Ibtidaiya": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Ibtidaiya" },
            "Sale Awwal": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sale Awwal" },
            "Sale Duwam": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sale Duwam" },
            "Ula": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Ula" },
            "Saniya": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Saniya" },
            "Salisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Salisa" },
            "Rabia": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Rabia" },
            "Khamisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Khamisa" },
            "Sadisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sadisa" },
            "Sabia": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sabia" },
            "Doratul Hadis": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Daurul Hadis" },
            "Takhassusat": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Takhassusat" },
            "Darulifta Ahle Sunnat": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Darul Ifta" },
            "Overall Rank": { id: null, sheet: null },
            "Result": { id: null, sheet: null },
            "Region Competition": { id: null, sheet: null }
        };

        const POLL_INTERVAL_MS = 5000;
        const LOCALSTORAGE_KEY = "telethone_sheet_overrides_enhanced_live";
        const LAST_RESULTS_KEY = "telethone_last_results";
        const LAST_FETCH_CYCLE_KEY = "telethone_last_fetch_cycle";
        const UNIT_DIVISOR = 7000;

        function parseSheetIdFromUrl(input) {
            if (!input) return null;
            input = input.trim();
            const m = input.match(/\/d\/([a-zA-Z0-9-_]{10,})/);
            if (m) return m[1];
            const m2 = input.match(/\/spreadsheets\/d\/e?\/(?:pubhtml\/)?([a-zA-Z0-9-_]{10,})/);
            if (m2) return m2[1];
            if (/^[a-zA-Z0-9-_]{10,}$/.test(input)) return input;
            return null;
        }

        function isValidSheetId(id) {
            return Boolean(id && /^[a-zA-Z0-9-_]{10,}$/.test(id));
        }

        function gvizUrl(sheetId, sheetName) {
            return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        }

        async function fetchSheetData(sheetId, sheetName) {
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const url = gvizUrl(sheetId, sheetName);
                    const res = await fetch(url, { cache: "no-cache" });
                    
                    if (res.status === 429) { 
                        if (attempt < 2) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error("Too many requests to Google Sheets API.");
                    }

                    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
                    const text = await res.text();

                    let jsonText = null;
                    const match = text.match(/setResponse\(([\s\S]*)\);?\s*$/);
                    if (match && match[1]) jsonText = match[1];
                    else {
                        const first = text.indexOf('{');
                        const last = text.lastIndexOf('}');
                        if (first !== -1 && last !== -1 && last > first) jsonText = text.slice(first, last + 1);
                    }

                    if (!jsonText) throw new Error('Could not extract JSON from GViz response; sheet may not be published or allowed.');

                    let data;
                    try {
                        data = JSON.parse(jsonText);
                    } catch (err) {
                        throw new Error('Failed to parse GViz JSON â€” ' + err.message);
                    }

                    const cols = (data.table.cols || []).map((c, i) => (c.label || c.id || `col${i}`).toString());
                    const rows = (data.table.rows || []).map((r) => r.c.map((cell) => (cell ? (cell.f !== undefined ? cell.f : cell.v) : null)));
                    const items = rows.map((r) => {
                        const obj = {};
                        cols.forEach((k, i) => (obj[k || `col${i}`] = r[i]));
                        return obj;
                    });
                    return { cols, items };

                } catch (error) {
                    if (attempt === 2) throw error;
                    if (error.message.includes("Too many requests")) throw error;
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Failed to fetch sheet data after multiple retries.");
        }

        const RANK_CANDIDATES = ["Rank", "S. R.", "S.R.", "S R", "Sr", "Serial", "S No", "S.No"];
        const USTAZ_CANDIDATES = ["Ustaz Name", "USTAZ NAME", "Ustaz", "Ustad", "Instructor", "Teacher", "Class"];
        const JAMIA_CANDIDATES = ["Jamia Name", "JAMIA NAME", "Jamia", "Jamiah"];
        const RAQAM_CANDIDATES = ["Raqam", "RAQAM", "Amount", "Value", "à¤°à¤•à¤®", "à¤°à¤¾à¤¶à¤¿"];
        const UNIT_CANDIDATES = ["Unit", "UNIT", "Units"];
        const REGION_CANDIDATES = ["Region", "REGION", "Zone"];
        const PHOTO_CANDIDATES = ["Photo", "Image", "Pic", "Profile Picture"];

        function findColumnByCandidates(cols, candidates) {
            const lower = cols.map((c) => (c || "").toLowerCase().trim());
            for (let cand of candidates) {
                const target = cand.toLowerCase().trim();
                const idx = lower.findIndex((c) => c === target);
                if (idx >= 0) return cols[idx];
            }
            for (let cand of candidates) {
                const token = cand.toLowerCase().trim();
                const idx = lower.findIndex((c) => c.includes(token));
                if (idx >= 0) return cols[idx];
            }
            return null;
        }

        function getGoogleDriveImageUrl(url) {
            if (!url || typeof url !== 'string') return null;
            const fileIdMatch = url.match(/[-\w]{25,}/);
            if (fileIdMatch && fileIdMatch[0]) {
                const fileId = fileIdMatch[0];
                return `https://lh3.googleusercontent.com/d/${fileId}`;
            }
            return url;
        }

        function medalForIndex(i) {
            if (i === 0) return "ðŸ¥‡";
            if (i === 1) return "ðŸ¥ˆ";
            if (i === 2) return "ðŸ¥‰";
            return "";
        }
        
        function calculateTimeRemaining(targetDate) {
            if (!targetDate) return { days: 0, hours: 0, minutes: 0, seconds: 0, expired: true };
            const now = new Date();
            const difference = targetDate - now;

            if (difference <= 0) {
                return { days: 0, hours: 0, minutes: 0, seconds: 0, expired: true };
            }

            const seconds = Math.floor((difference / 1000) % 60);
            const minutes = Math.floor((difference / 1000 / 60) % 60);
            const hours = Math.floor((difference / (1000 * 60 * 60)) % 24);
            const days = Math.floor(difference / (1000 * 60 * 60 * 24));
            
            return { days, hours, minutes, seconds, expired: false }; 
        }
        
        function parseNumericValue(value, isInteger = false) {
            if (value === null || value === undefined || String(value).trim() === "") {
                return NaN;
            }
            const cleaned = String(value).replace(/[^0-9.-]+/g, "");
            const n = Number(cleaned);
            
            if (Number.isNaN(n)) return NaN;
            
            return isInteger ? Math.round(n) : n;
        }

        function formatDateTimeForPoster(date) {
            const options = {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            };
            return new Intl.DateTimeFormat('en-IN', options).format(date).replace(',', '');
        }

        // --- Reusable Poster Components ---
        
        const PodiumWinnerCard = ({ winner, rank }) => {
            if (!winner) return null;

            const styles = {
                1: { cardWidth: '200px', marginBottom: '0', imageHeight: '200px' },
                2: { cardWidth: '180px', marginBottom: '20px', imageHeight: '170px' },
                3: { cardWidth: '180px', marginBottom: '20px', imageHeight: '170px' },
                4: { cardWidth: '160px', marginBottom: '40px', imageHeight: '150px' },
                5: { cardWidth: '160px', marginBottom: '40px', imageHeight: '150px' },
                6: { cardWidth: '150px', marginBottom: '10px', imageHeight: '140px' },
            };
            const style = styles[rank] || styles[6];
            const numericImageHeight = parseInt(style.imageHeight, 10);

            const cardStyle = {
                backgroundColor: '#ffffff', borderRadius: '12px', padding: '10px',
                boxShadow: '0 4px 15px rgba(0,0,0,0.1)', position: 'relative', textAlign: 'center',
                width: style.cardWidth,
                marginBottom: style.marginBottom,
            };
            
            const imageContainerStyle = {
                height: style.imageHeight,
                backgroundColor: '#bbdefb', borderRadius: '8px', margin: '10px 0', 
                display: 'flex', position: 'relative', overflow: 'hidden'
            };

            return (
                <div style={cardStyle}>
                    <div style={{ position: 'absolute', top: '-20px', right: '10px', zIndex: 10 }}>
                        <div style={{ position: 'absolute', top: '10px', left: '50%', transform: 'translateX(-50%)', zIndex: 1 }}>
                            <div style={{ content: '', position: 'absolute', width: '15px', height: '35px', background: '#1e88e5', top: '0', left: '-10px', transform: 'rotate(-35deg)', borderBottomLeftRadius: '8px', borderBottomRightRadius: '8px' }}></div>
                            <div style={{ content: '', position: 'absolute', width: '15px', height: '35px', background: '#1e88e5', top: '0', left: '-3px', transform: 'rotate(35deg)', borderBottomLeftRadius: '8px', borderBottomRightRadius: '8px' }}></div>
                        </div>
                        <div style={{ width: '40px', height: '40px', background: '#1976d2', borderRadius: '50%', display: 'flex', justifyContent: 'center', alignItems: 'center', color: 'white', fontSize: '20px', fontWeight: 'bold', border: '3px solid white', position: 'relative', zIndex: 2 }}>{rank}</div>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', padding: '5px' }}>
                         <img src={winner.photoUrl || 'https://placehold.co/30x30/e0e0e0/ffffff?text=?'} style={{ width: '30px', height: '30px', backgroundColor: '#e0e0e0', borderRadius: '50%', objectFit: 'cover' }} />
                    </div>
                    <div style={imageContainerStyle}>
                         <img src={winner.photoUrl || `https://placehold.co/${numericImageHeight}x${numericImageHeight}/bbdefb/ffffff?text=${encodeURIComponent(winner.jamia)}`} alt={winner.jamia} style={{width: '100%', height: '100%', objectFit: 'cover'}}/>
                    </div>
                    <div style={{ marginTop: '10px', color: '#212121', textAlign: 'center' }}>
                        <div style={{ fontWeight: 'bold', fontSize: '16px' }}>{winner.ustaz}</div>
                        <div style={{ fontSize: '14px', color: '#616161' }}>{winner.jamia}</div>
                    </div>
                </div>
            );
        };
        
        const PosterLayout = ({ children, width = '800px', height = '800px' }) => (
            <div id="poster-to-download" style={{
                width, height, background: 'linear-gradient(to bottom, #fdeec9, #e0f7fa)',
                position: 'relative', overflow: 'hidden', display: 'flex', flexDirection: 'column',
                alignItems: 'center', padding: '40px', boxSizing: 'border-box', fontFamily: "'Poppins', sans-serif"
            }}>
                <svg style={{position: 'absolute', width: '100px', height: '100px', top: '20px', left: '-20px', transform: 'rotate(-15deg)', opacity: 0.8}} viewBox="0 0 1024 1024" fill="#4fc3f7"><path d="M853.333333 85.333333H170.666667c-47.146667 0-85.333333 38.186667-85.333334 85.333334v426.666666c0 47.146667 38.186667 85.333333 85.333334 85.333334h469.333333L853.333333 853.333333V170.666667c0-47.146667-38.186667-85.333333-85.333333-85.333334z" /></svg>
                <svg style={{position: 'absolute', width: '100px', height: '100px', top: '60px', right: '-10px', transform: 'rotate(15deg)', opacity: 0.8}} viewBox="0 0 1024 1024" fill="#4fc3f7"><path d="M810.666667 128l170.666666 213.333333-170.666666 213.333334V426.666667H597.333333c0-141.653333-114.346667-256-256-256V85.333333c232.533333 0 426.666667 184.96 426.666667 416.853334h34.133333v-374.186667z" /></svg>
                <svg style={{position: 'absolute', width: '100px', height: '100px', bottom: '80px', left: '10px', opacity: 0.8}} viewBox="0 0 1024 1024" fill="#81c784"><path d="M896 426.666667c0-29.013333-23.466667-52.48-52.48-52.48H629.333333V160c0-47.146667-38.186667-85.333333-85.333333-85.333333h-85.333333c-30.293333 0-56.32 16.64-71.253334 40.96C372.48 136.533333 362.666667 160 362.666667 192v182.666667H180.48c-29.013333 0-52.48 23.466667-52.48 52.48v427.52c0 29.013333 23.466667 52.48 52.48 52.48h663.04c29.013333 0 52.48-23.466667 52.48-52.48V426.666667z" /></svg>
                {children}
            </div>
        );
        
        const PosterHeader = ({ className, title }) => (
             <div style={{ textAlign: 'center', marginBottom: '20px', zIndex: 5 }}>
                <div style={{ backgroundColor: '#1e88e5', color: 'white', padding: '8px 25px', borderRadius: '20px', fontSize: '18px', fontWeight: 'bold', display: 'inline-block', marginBottom: '10px', letterSpacing: '1px' }}>CONGREGATION</div>
                <h1 style={{ fontFamily: "'Fredoka One', cursive", fontSize: '80px', fontWeight: 'bold', color: '#1565c0', margin: 0, lineHeight: 1 }}>TELETHON-2025</h1>
                <h2 style={{ color: '#546e7a', fontSize: '28px', fontWeight: 'bold', marginTop: '15px', letterSpacing: '1px' }}>{title}</h2>
                <h3 style={{ fontFamily: "'Bowlby One SC', cursive", color: '#1e88e5', fontSize: '48px', margin: '10px 0 20px 0', textTransform: 'uppercase' }}>{className}</h3>
            </div>
        );
        
        const PosterFooter = ({ date }) => (
             <div style={{ position: 'absolute', bottom: '30px', width: 'calc(100% - 80px)', display: 'flex', justifyContent: 'space-between', alignItems: 'center', color: '#1565c0', fontWeight: 'bold', fontSize: '16px', zIndex: 5 }}>
                <span>MAJLIS TALIMI UMOOR INDIA</span>
                <span>{date}</span>
            </div>
        );

        const Podium3Poster = ({ data }) => {
            if (!data) return null;
            const { className, winners, date } = data;
            
            const sortedWinners = [...winners].sort((a, b) => b.__value - a.__value);
            const winnerMap = {
                first: sortedWinners[0],
                second: sortedWinners[1],
                third: sortedWinners[2]
            };
            
            return (
                <PosterLayout>
                    <PosterHeader className={className} title="TOP 3 WINNERS" />
                    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'flex-end', gap: '20px', width: '100%', flex: 1 }}>
                        <PodiumWinnerCard winner={winnerMap.second} rank={2} />
                        <PodiumWinnerCard winner={winnerMap.first} rank={1} />
                        <PodiumWinnerCard winner={winnerMap.third} rank={3} />
                    </div>
                    <PosterFooter date={date} />
                </PosterLayout>
            );
        };
        
        const Podium5Poster = ({ data }) => {
            if (!data) return null;
            const { className, winners, date } = data;
            
            const sortedWinners = [...winners].sort((a, b) => b.__value - a.__value);
            const winnerMap = {
                first: sortedWinners[0],
                second: sortedWinners[1],
                third: sortedWinners[2],
                fourth: sortedWinners[3],
                fifth: sortedWinners[4],
            };
            
            return (
                 <PosterLayout width="1200px">
                    <PosterHeader className={className} title="TOP 5 WINNERS" />
                    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'flex-end', gap: '15px', width: '100%', flex: 1 }}>
                        <PodiumWinnerCard winner={winnerMap.fourth} rank={4} />
                        <PodiumWinnerCard winner={winnerMap.second} rank={2} />
                        <PodiumWinnerCard winner={winnerMap.first} rank={1} />
                        <PodiumWinnerCard winner={winnerMap.third} rank={3} />
                        <PodiumWinnerCard winner={winnerMap.fifth} rank={5} />
                    </div>
                    <PosterFooter date={date} />
                </PosterLayout>
            );
        };

        const Podium10Poster = ({ data }) => {
            if (!data) return null;
            const { className, winners, date } = data;
            const sortedWinners = [...winners].sort((a, b) => b.__value - a.__value);

            return (
                 <PosterLayout width="1920px" height="1080px">
                    <PosterHeader className={className} title="TOP 10 WINNERS" />
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '20px', width: '100%', justifyContent: 'center' }}>
                        {sortedWinners.map((winner, idx) => (
                           <PodiumWinnerCard key={idx} winner={winner} rank={idx + 1} />
                        ))}
                    </div>
                    <PosterFooter date={date} />
                </PosterLayout>
            );
        };
        
        const ListPoster = ({ data }) => {
            if (!data) return null;
            const { className, winners, date, title } = data;
            const isTakhassusat = className === 'Takhassusat';
            const subTitle = title.replace('TELETHON 2025 ', '') + (title.includes('FULL LIST') ? '' : ' WINNERS');

            return (
                <div id="poster-to-download" style={{
                    width: '1200px',
                    height: 'auto',
                    minHeight: '675px',
                    padding: '32px',
                    background: 'linear-gradient(135deg, #f0f9ff, #eef2ff)',
                    fontFamily: "'Inter', sans-serif",
                    display: 'flex',
                    flexDirection: 'column',
                }}>
                    <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                        <h1 style={{ fontFamily: "'Bebas Neue', cursive", fontSize: '72px', color: '#1e3a8a', letterSpacing: '2px', margin: 0 }}>TELETHON 2025</h1>
                        <p style={{ fontFamily: "'Bebas Neue', cursive", fontSize: '48px', color: '#6366f1', letterSpacing: '2px', margin: '-10px 0 0 0' }}>{subTitle}</p>
                        <h2 style={{ fontFamily: "'Bowlby One SC', cursive", fontSize: '60px', color: '#0ea5e9', textTransform: 'uppercase', margin: 0 }}>{className}</h2>
                    </div>
                    
                    <div style={{ flexGrow: 1 }}>
                         <div style={{
                            display: 'grid',
                            gridTemplateColumns: '80px 200px 1fr 200px 200px',
                            alignItems: 'center',
                            gap: '16px',
                            padding: '12px 16px',
                            background: '#dbeafe',
                            borderRadius: '12px',
                            fontWeight: 'bold',
                            fontSize: '20px',
                            color: '#1e3a8a',
                            marginBottom: '12px'
                        }}>
                            <span>Rank</span>
                            <span>{isTakhassusat ? 'Jamia Name' : 'Ustaz Name'}</span>
                            <span style={{ textAlign: 'center' }}>{isTakhassusat ? 'Class' : 'Jamia Name'}</span>
                            <span style={{ textAlign: 'right' }}>Raqam</span>
                            <span style={{ textAlign: 'right' }}>Unit</span>
                        </div>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            {winners.map((winner, idx) => {
                                const rankColors = [
                                    'rgba(252, 211, 77, 0.3)', // Gold
                                    'rgba(192, 192, 192, 0.3)', // Silver
                                    'rgba(205, 127, 50, 0.3)'  // Bronze
                                ];
                                const bgColor = idx < 3 ? rankColors[idx] : 'rgba(255,255,255,0.7)';
                                const textColor = '#1e293b';

                                return (
                                    <div key={winner.__id || idx} style={{
                                        display: 'grid',
                                        gridTemplateColumns: '80px 200px 1fr 200px 200px',
                                        alignItems: 'center',
                                        gap: '16px',
                                        padding: '12px 16px',
                                        background: bgColor,
                                        borderRadius: '12px',
                                        fontSize: '22px',
                                        color: textColor,
                                        fontWeight: 500
                                    }}>
                                        <span style={{fontWeight: 'bold', fontSize: '24px'}}>{idx + 1}</span>
                                        <span>{isTakhassusat ? winner.jamia : winner.ustaz}</span>
                                        <span style={{ textAlign: 'center', fontWeight: 'bold' }}>
                                            {medalForIndex(idx)} {isTakhassusat ? winner.ustaz : winner.jamia}
                                        </span>
                                        <span style={{ textAlign: 'right', fontWeight: 'bold' }}>{winner.__value.toLocaleString()}</span>
                                        <span style={{ 
                                            textAlign: 'right', 
                                            fontFamily: "'Bebas Neue', cursive",
                                            fontSize: '28px',
                                            color: '#4f46e5'
                                        }}>{winner.unit}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                     <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '24px', paddingTop: '16px', borderTop: '2px solid #dbeafe'}}>
                        <p style={{ color: '#475569', fontSize: '18px', fontWeight: '600' }}>Majlis Talimi Umoor India</p>
                        <p style={{ color: '#475569', fontSize: '18px', fontWeight: '600' }}>Date: {date}</p>
                    </div>
                </div>
            );
        };

        const OverallRankPoster = ({ data }) => {
            if (!data) return null;
            const { winners, date } = data;

            return (
                <div id="poster-to-download" style={{
                    width: '1200px',
                    height: 'auto',
                    minHeight: '675px',
                    padding: '32px',
                    background: 'linear-gradient(135deg, #e0f2fe, #f5f3ff)',
                    fontFamily: "'Inter', sans-serif",
                    display: 'flex',
                    flexDirection: 'column',
                }}>
                    <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                        <h1 style={{ fontFamily: "'Bebas Neue', cursive", fontSize: '72px', color: '#1e3a8a', letterSpacing: '2px', margin: 0 }}>TELETHON 2025</h1>
                        <p style={{ fontFamily: "'Bebas Neue', cursive", fontSize: '48px', color: '#6366f1', letterSpacing: '2px', margin: '-10px 0 0 0' }}>ALL INDIA CLASSIC RANK</p>
                    </div>

                    <div style={{ flexGrow: 1 }}>
                         <div style={{
                            display: 'grid',
                            gridTemplateColumns: '80px 1fr 200px 200px',
                            alignItems: 'center',
                            gap: '16px',
                            padding: '12px 16px',
                            background: '#dbeafe',
                            borderRadius: '12px',
                            fontWeight: 'bold',
                            fontSize: '20px',
                            color: '#1e3a8a',
                            marginBottom: '12px'
                        }}>
                            <span>Rank</span>
                            <span>Class Name</span>
                            <span style={{ textAlign: 'right' }}>Unit</span>
                            <span style={{ textAlign: 'right' }}>Total Amount</span>
                        </div>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            {winners.map((winner, idx) => {
                                const rankColors = [
                                    'rgba(252, 211, 77, 0.3)', // Gold
                                    'rgba(192, 192, 192, 0.3)', // Silver
                                    'rgba(205, 127, 50, 0.3)'  // Bronze
                                ];
                                const bgColor = idx < 3 ? rankColors[idx] : 'rgba(255,255,255,0.7)';
                                const textColor = '#1e293b';

                                return (
                                    <div key={winner.className} style={{
                                        display: 'grid',
                                        gridTemplateColumns: '80px 1fr 200px 200px',
                                        alignItems: 'center',
                                        gap: '16px',
                                        padding: '12px 16px',
                                        background: bgColor,
                                        borderRadius: '12px',
                                        fontSize: '22px',
                                        color: textColor,
                                        fontWeight: 500
                                    }}>
                                        <span style={{fontWeight: 'bold', fontSize: '24px'}}>{idx + 1}</span>
                                        <span style={{ fontWeight: 'bold' }}>
                                            {medalForIndex(idx)} {winner.className}
                                        </span>
                                        <span style={{
                                            textAlign: 'right',
                                            fontFamily: "'Bebas Neue', cursive",
                                            fontSize: '28px',
                                            color: '#4f46e5'
                                        }}>{formatOverallUnit(winner.totalAmount)}</span>
                                        <span style={{ textAlign: 'right', fontWeight: 'bold' }}>{winner.totalAmount.toLocaleString()}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                     <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '24px', paddingTop: '16px', borderTop: '2px solid #dbeafe'}}>
                        <p style={{ color: '#475569', fontSize: '18px', fontWeight: '600' }}>Majlis Talimi Umoor India</p>
                        <p style={{ color: '#475569', fontSize: '18px', fontWeight: '600' }}>Date: {date}</p>
                    </div>
                </div>
            );
        };
        
        const PdfResultPoster = ({ data }) => {
            if (!data) return null;
            const { winners, date } = data;
            const classOrder = Object.keys(DEFAULT_SHEET_CONFIGS).filter(key => winners[key]);

            return (
                <div id="poster-to-download" style={{
                    width: '1240px',
                    padding: '40px',
                    background: 'white',
                    fontFamily: "'Inter', sans-serif",
                    color: '#1e293b',
                }}>
                    <div style={{ textAlign: 'center', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px', marginBottom: '24px' }}>
                        <h1 style={{ fontFamily: "'Bebas Neue', cursive", fontSize: '60px', color: '#1e3a8a', letterSpacing: '2px', margin: 0 }}>TELETHON 2025</h1>
                        <p style={{ fontFamily: "'Bebas Neue', cursive", fontSize: '40px', color: '#6366f1', letterSpacing: '2px', margin: 0 }}>QUARTER FINAL COMPETITION RESULTS</p>
                        <p style={{ fontSize: '16px', color: '#475569', marginTop: '8px' }}>Date: {date}</p>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '24px' }}>
                        {classOrder.map(className => (
                            <div key={className} style={{ border: '1px solid #cbd5e1', borderRadius: '12px', padding: '16px', backgroundColor: '#f8fafc', breakInside: 'avoid' }}>
                                <h3 style={{ fontFamily: "'Bowlby One SC', cursive", fontSize: '24px', color: '#1e3a8a', marginBottom: '12px', textAlign: 'center', borderBottom: '1px solid #e2e8f0', paddingBottom: '8px' }}>
                                    {className}
                                </h3>
                                <ol style={{ listStyle: 'none', padding: 0, margin: 0, display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    {winners[className].slice(0, 3).map((winner, idx) => (
                                        <li key={idx} style={{ display: 'flex', alignItems: 'center', padding: '8px', borderRadius: '6px', background: ['#fffbeb', '#f0f9ff', '#f0fdf4'][idx] }}>
                                            <span style={{ fontSize: '24px', marginRight: '12px' }}>{medalForIndex(idx)}</span>
                                            <div>
                                                <p style={{ fontWeight: '600', fontSize: '16px', margin: 0 }}>{winner.jamia}</p>
                                                <p style={{ fontSize: '14px', color: '#64748b', margin: 0 }}>{winner.ustaz}</p>
                                            </div>
                                            <div style={{ marginLeft: 'auto', textAlign: 'right' }}>
                                                 <span style={{ fontFamily: "'Bebas Neue', cursive", fontSize: '22px', color: '#4f46e5' }}>{winner.unit}</span>
                                                 <span style={{ display: 'block', fontSize: '10px', color: '#64748b', marginTop: '-4px' }}>UNITS</span>
                                            </div>
                                        </li>
                                    ))}
                                </ol>
                            </div>
                        ))}
                    </div>
                     <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', marginTop: '32px', paddingTop: '16px', borderTop: '2px solid #e2e8f0'}}>
                        <p style={{ color: '#475569', fontSize: '16px', fontWeight: '600' }}>Majlis Talimi Umoor India</p>
                    </div>
                </div>
            );
        };

        // --- Region Competition Component ---
        const RegionCompetitionView = ({ regionData, isLoading, error }) => {
            const getUnit = (regionName) => {
                 if (!regionName) return 0;
                 const regionNames = Object.keys(regionData);
                 const actualRegionName = regionNames.find(name => name.toLowerCase() === regionName.toLowerCase());
                 return regionData[actualRegionName]?.totalUnit || 0;
            };

            const matchups = [
                { id: 1, teamA: 'Ajmer', teamB: 'Dehli' },
                { id: 2, teamA: 'Mumbai', teamB: 'HYDERABAD & BENGALORE' },
                { id: 3, teamA: 'Kolkata', teamB: 'HYDERABAD' }
            ];

            const calculateScore = (teamName) => {
                if (teamName === 'HYDERABAD & BENGALORE') {
                    return getUnit('HYDERABAD') + getUnit('BENGALORE');
                }
                return getUnit(teamName);
            };
            
            if (isLoading && Object.keys(regionData).length === 0) {
                 return (
                    <div className="flex justify-center items-center p-10">
                        <div className="loader w-10 h-10 border-t-sky-500 border-4"></div>
                        <span className="ml-4 text-slate-500">Region data load ho raha hai...</span>
                    </div>
                );
            }

            if (error) return <div className="text-center p-4 text-rose-600">{error}</div>;
            
            if (Object.keys(regionData).length === 0 && !isLoading) {
                 return <div className="text-center p-10 text-slate-500">Koi region data nahi mila. Sheets mein 'Region' column check karein.</div>;
            }

            return (
                <div className="bg-white border rounded-lg p-4 shadow-lg relative">
                    <h2 className="text-2xl md:text-3xl font-bold text-slate-800 mb-6 text-center">Region Competition Scoreboard</h2>
                    <div className="space-y-6">
                        {matchups.map(match => {
                            const scoreA = calculateScore(match.teamA);
                            const scoreB = calculateScore(match.teamB);
                            const winner = scoreA > scoreB ? 'A' : (scoreB > scoreA ? 'B' : 'None');

                            return (
                                <div key={match.id} className="bg-slate-50 border border-slate-200 p-3 md:p-4 rounded-2xl shadow-md transform hover:scale-105 transition-transform duration-300">
                                    <div className="md:hidden">
                                        <div className={`flex justify-between items-center p-2 rounded-lg mb-2 ${winner === 'A' ? 'bg-green-50' : ''}`}>
                                            <span className={`text-lg font-['Bowlby_One_SC'] uppercase ${winner === 'A' ? 'text-green-600' : 'text-slate-700'}`}>{match.teamA}</span>
                                            <span className={`text-2xl font-['Bebas_Neue'] tracking-wider ${winner === 'A' ? 'text-green-500' : 'text-slate-500'}`}>
                                                <AnimatedNumber value={scoreA} formatter={(val) => val.toFixed(1)} />
                                            </span>
                                        </div>
                                        <div className="text-center text-slate-400 font-bold my-1 text-xl">VS</div>
                                        <div className={`flex justify-between items-center p-2 rounded-lg ${winner === 'B' ? 'bg-green-50' : ''}`}>
                                            <span className={`text-lg font-['Bowlby_One_SC'] uppercase ${winner === 'B' ? 'text-green-600' : 'text-slate-700'}`}>{match.teamB}</span>
                                            <span className={`text-2xl font-['Bebas_Neue'] tracking-wider ${winner === 'B' ? 'text-green-500' : 'text-slate-500'}`}>
                                                <AnimatedNumber value={scoreB} formatter={(val) => val.toFixed(1)} />
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div className="hidden md:flex justify-around items-center text-center">
                                        <div className={`flex-1 flex flex-col items-center p-2 rounded-lg ${winner === 'A' ? 'font-extrabold' : ''}`}>
                                            <div className={`text-xl md:text-2xl font-['Bowlby_One_SC'] uppercase ${winner === 'A' ? 'text-green-600' : 'text-slate-700'}`}>{match.teamA}</div>
                                            <div className="text-xs text-slate-500">Region</div>
                                        </div>
                                        <div className="flex items-center">
                                             <div className={`text-3xl md:text-5xl font-['Bebas_Neue'] p-2 rounded-lg tracking-wider ${winner === 'A' ? 'text-green-500' : 'text-slate-500'}`}>
                                                <AnimatedNumber value={scoreA} formatter={(val) => val.toFixed(1)} />
                                             </div>
                                             <div className="text-2xl md:text-4xl font-extrabold text-slate-400 mx-4">VS</div>
                                             <div className={`text-3xl md:text-5xl font-['Bebas_Neue'] p-2 rounded-lg tracking-wider ${winner === 'B' ? 'text-green-500' : 'text-slate-500'}`}>
                                                 <AnimatedNumber value={scoreB} formatter={(val) => val.toFixed(1)} />
                                             </div>
                                        </div>
                                        <div className={`flex-1 flex flex-col items-center p-2 rounded-lg ${winner === 'B' ? 'font-extrabold' : ''}`}>
                                             <div className={`text-xl md:text-2xl font-['Bowlby_One_SC'] uppercase ${winner === 'B' ? 'text-green-600' : 'text-slate-700'}`}>{match.teamB}</div>
                                            <div className="text-xs text-slate-500">Region</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        function TelethoneEnhancedLive() {
            const allOptions = Object.keys(DEFAULT_SHEET_CONFIGS);
            const [active, setActive] = useState("Ibtidaiya"); 
            const [overrides, setOverrides] = useState(() => {
                try {
                    const raw = localStorage.getItem(LOCALSTORAGE_KEY);
                    if (raw) return JSON.parse(raw);
                } catch (e) {}
                const out = {};
                for (let k of Object.keys(DEFAULT_SHEET_CONFIGS)) if (DEFAULT_SHEET_CONFIGS[k].id) out[k] = DEFAULT_SHEET_CONFIGS[k].id;
                return out;
            });

            useEffect(() => {
                try {
                    localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(overrides));
                } catch (e) {}
            }, [overrides]);

            const [data, setData] = useState({ items: [] });
            const [isLoading, setLoading] = useState(true); 
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [error, setError] = useState(null);
            const [sheetInput, setSheetInput] = useState("");
            const [highlightKey, setHighlightKey] = useState(null);
            
            // NOTE: To change the result announcement time, modify the date string below.
            // Format: 'YYYY-MM-DDTHH:mm:ss' (e.g., '2025-10-08T21:30:00')
            const [targetDate, setTargetDate] = useState(new Date('2025-10-08T23:15:00'));

            // NOTE: To change the result page heading, modify the text below.
            const resultPageHeading = "Grand Final competition";
            
            const [countdown, setCountdown] = useState(() => calculateTimeRemaining(targetDate));

            const [resultData, setResultData] = useState(() => {
                try {
                    const savedResults = localStorage.getItem(LAST_RESULTS_KEY);
                    return savedResults ? JSON.parse(savedResults) : {};
                } catch { return {}; }
            });

            const [isResultLoading, setResultLoading] = useState(false);
            const [resultError, setResultError] = useState(null);
            const [overallRankData, setOverallRankData] = useState([]);
            const [isRankLoading, setRankLoading] = useState(true);
            const [isRankDataLoaded, setIsRankDataLoaded] = useState(false);
            const [rankError, setRankError] = useState(null);
            const [regionData, setRegionData] = useState({});
            const [isRegionLoading, setRegionLoading] = useState(true);
            const [regionError, setRegionError] = useState(null);
            const [posterData, setPosterData] = useState(null);
            const [isDownloading, setIsDownloading] = useState(false);
            const posterContainerRef = useRef(null);

            useEffect(() => {
                posterContainerRef.current = document.getElementById('poster-container');
                loadOverallRank();
                loadRegionData();
            }, []);
            
            // Poster Generation Effect
            useEffect(() => {
                if (!posterData) return;

                const generateImage = async () => {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    const element = document.getElementById('poster-to-download');
                    if(element && window.html2canvas) {
                        try {
                            const canvas = await html2canvas(element, { useCORS: true, scale: 2 });
                            const dataUrl = canvas.toDataURL('image/png');
                            
                            if (posterData.type === 'pdf') {
                                const { jsPDF } = window.jspdf;
                                const pdf = new jsPDF({
                                    orientation: 'p',
                                    unit: 'px',
                                    format: [canvas.width, canvas.height]
                                });
                                pdf.addImage(dataUrl, 'PNG', 0, 0, canvas.width, canvas.height);
                                pdf.save('Telethone-Results-Summary.pdf');
                            } else {
                                const link = document.createElement('a');
                                link.href = dataUrl;
                                link.download = `Telethone-Winners-${posterData.className.replace(/\s+/g, '-')}.png`;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }

                        } catch(err) {
                             console.error("Error generating poster:", err);
                             alert("Poster download karne mein error aaya. Koshish karein ki photo links sahi hon.");
                        } finally {
                             setPosterData(null);
                             setIsDownloading(false);
                        }
                    }
                };
                
                generateImage();

            }, [posterData]);

            const handleDownloadTop3PodiumPoster = (className, winners) => {
                 setIsDownloading(true);
                 const now = formatDateTimeForPoster(new Date());
                 const top3Winners = winners.slice(0, 3);
                 setPosterData({ type: 'podium3', className, winners: top3Winners, date: now });
            };

            const handleDownloadTop5PodiumPoster = (className, winners) => {
                const now = formatDateTimeForPoster(new Date());
                setIsDownloading(true);
                const topWinners = winners.slice(0, 5);
                setPosterData({
                    type: 'podium5',
                    className: className,
                    winners: topWinners,
                    date: now,
                });
            };

            const handleDownloadTop10PodiumPoster = (className, winners) => {
                const now = formatDateTimeForPoster(new Date());
                setIsDownloading(true);
                const topWinners = winners.slice(0, 10);
                setPosterData({
                    type: 'podium10',
                    className: className,
                    winners: topWinners,
                    date: now,
                });
            };

            const handleDownloadClassPoster = (count, className, winners) => {
                const now = formatDateTimeForPoster(new Date());
                
                setIsDownloading(true);
                const winnerList = (winners || data.items).slice(0, count);
                setPosterData({ 
                    type: 'list', 
                    className: className || active, 
                    winners: winnerList, 
                    date: now, 
                    title: `TELETHON 2025 TOP ${count}` 
                });
            };

            const handleDownloadFullListPoster = () => {
                const now = formatDateTimeForPoster(new Date());
                
                setIsDownloading(true);
                const winners = data.items;
                setPosterData({ 
                    type: 'list', 
                    className: active, 
                    winners, 
                    date: now, 
                    title: `TELETHON 2025 FULL LIST` 
                });
            };

            const handleDownloadOverallRankPoster = () => {
                if (overallRankData.length === 0) return;
                const now = formatDateTimeForPoster(new Date());
                setIsDownloading(true);
                setPosterData({
                    type: 'overall',
                    className: 'Overall-Rank',
                    winners: overallRankData,
                    date: now,
                    title: 'TELETHON 2025 ALL INDIA CLASSIC RANK'
                });
            };

            const handleDownloadPdfResult = () => {
                if (Object.keys(resultData).length === 0) return;
                const now = formatDateTimeForPoster(new Date());
                setIsDownloading(true);
                setPosterData({
                    type: 'pdf',
                    className: 'Full-Results',
                    winners: resultData,
                    date: now,
                });
            };


            function getActiveConfig() {
                const cfg = DEFAULT_SHEET_CONFIGS[active] || { id: "", sheet: "Sheet1" };
                const id = overrides[active] ?? cfg.id ?? "";
                return { id, sheet: cfg.sheet || "Sheet1" };
            }

            async function loadActiveSheet() {
                const { id, sheet } = getActiveConfig();
                
                if (!isValidSheetId(id)) {
                    setData({ items: [] });
                    setError(null);
                    setLoading(false);
                    return;
                }

                setLoading(true);
                setError(null);
                try {
                    const { cols, items: rows } = await fetchSheetData(id, sheet);
                    const rankCol = findColumnByCandidates(cols, RANK_CANDIDATES);
                    const ustazCol = findColumnByCandidates(cols, USTAZ_CANDIDATES);
                    const jamiaCol = findColumnByCandidates(cols, JAMIA_CANDIDATES);
                    const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);

                    if (!jamiaCol || !raqamCol) {
                        setError("Sheet mein 'Jamia Name' aur 'Raqam' ke headers hone chahiye.");
                        setData({ items: [] });
                        setLoading(false);
                        setIsDataLoaded(true);
                        return;
                    }

                    const parsed = rows
                        .map((r, idx) => {
                            const n = parseNumericValue(r[raqamCol]);
                            return { 
                                __id: idx, 
                                rank: String(r[rankCol] || "").trim(), 
                                ustaz: String(r[ustazCol] || "").trim(), 
                                jamia: String(r[jamiaCol] || "").trim(), 
                                unit: formatUnit(n),
                                raqamRaw: r[raqamCol], 
                                __value: n
                            };
                        })
                        .filter((x) => x.jamia !== "" && !Number.isNaN(x.__value));

                    parsed.sort((a, b) => b.__value - a.__value);
                    
                    const newTopId = parsed.length ? parsed[0].__id : null;
                    if (newTopId !== null && newTopId !== highlightKey) {
                        setHighlightKey(newTopId);
                        setTimeout(() => setHighlightKey(null), 1200);
                    }

                    setData({ items: parsed });
                } catch (err) {
                    console.error(err);
                    setError(err.message || String(err));
                    setData({ items: [] });
                } finally {
                    setLoading(false);
                    setIsDataLoaded(true);
                }
            }
            
            async function loadOverallRank() {
                setRankLoading(true);
                setRankError(null);
                const sheetOptions = allOptions.filter(key => DEFAULT_SHEET_CONFIGS[key].id);
                
                const fetchPromises = sheetOptions.map(async (opt) => {
                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                    const id = overrides[opt] ?? cfg.id;
                    if (!isValidSheetId(id)) return { className: opt, totalAmount: 0, totalUnit: 0, error: "Not Configured" };

                    try {
                        const { cols, items: rows } = await fetchSheetData(id, cfg.sheet);
                        const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);
                        if (!raqamCol) return { className: opt, totalAmount: 0, totalUnit: 0, error: "Missing Raqam Column" };
                        
                        let totalAmount = 0;
                        rows.forEach((r) => {
                            const n = parseNumericValue(r[raqamCol]);
                            totalAmount += Number.isNaN(n) ? 0 : n;
                        });
                        
                        return { className: opt, totalAmount, totalUnit: totalAmount / UNIT_DIVISOR, error: null };
                    } catch (err) {
                        return { className: opt, totalAmount: 0, totalUnit: 0, error: err.message };
                    }
                });

                try {
                    const results = await Promise.all(fetchPromises);
                    const validResults = results.filter(r => r.totalAmount > 0 || (r.error && r.error.includes("Missing Raqam Column")));
                    setOverallRankData(validResults.sort((a, b) => b.totalAmount - a.totalAmount));
                } catch (e) {
                    setRankError("Sabhi rank data ko process nahi kiya ja saka.");
                } finally {
                     setRankLoading(false);
                     setIsRankDataLoaded(true);
                }
            }

            const loadAllResults = async () => {
                if (isResultLoading) return;
                setResultLoading(true);
                setResultError(null);
                const sheetOptions = allOptions.filter(key => DEFAULT_SHEET_CONFIGS[key].id);

                const fetchPromises = sheetOptions.map(async (opt) => {
                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                    const id = overrides[opt] ?? cfg.id;
                    if (!isValidSheetId(id)) return { className: opt, winners: [], error: "Not Configured" };

                    try {
                        const { cols, items: rows } = await fetchSheetData(id, cfg.sheet);
                        const jamiaCol = findColumnByCandidates(cols, JAMIA_CANDIDATES);
                        const ustazCol = findColumnByCandidates(cols, USTAZ_CANDIDATES);
                        const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);
                        const photoCol = findColumnByCandidates(cols, PHOTO_CANDIDATES);

                        if (!jamiaCol || !raqamCol) return { className: opt, winners: [], error: "Missing Columns" };

                        const parsed = rows
                            .map((r, idx) => {
                                const value = parseNumericValue(r[raqamCol]);
                                return {
                                    __id: idx,
                                    ustaz: String(r[ustazCol] || "").trim(),
                                    jamia: String(r[jamiaCol] || "").trim(),
                                    __value: value,
                                    unit: formatUnit(value),
                                    photoUrl: photoCol ? getGoogleDriveImageUrl(r[photoCol]) : null
                                };
                            })
                            .filter(x => x.jamia !== "" && !Number.isNaN(x.__value));
                        parsed.sort((a, b) => b.__value - a.__value);
                        return { className: opt, winners: parsed.slice(0, 10) };
                    } catch (err) {
                        return { className: opt, winners: [], error: err.message };
                    }
                });

                try {
                    const results = await Promise.all(fetchPromises);
                    const winnersMap = {};
                    results.forEach(r => {
                        if (r.winners.length > 0) winnersMap[r.className] = r.winners;
                        if (r.error?.includes("Too many requests")) setResultError(r.error);
                    });
                    setResultData(winnersMap);
                    localStorage.setItem(LAST_RESULTS_KEY, JSON.stringify(winnersMap));
                } catch (e) {
                    setResultError("Sabhi results data ko process nahi kiya ja saka.");
                } finally {
                    setResultLoading(false);
                }
            }
            
            async function loadRegionData() {
                setRegionLoading(true);
                setRegionError(null);
                const sheetOptions = allOptions.filter(key => DEFAULT_SHEET_CONFIGS[key].id);
                const regionTotals = {};

                const fetchPromises = sheetOptions.map(async (opt) => {
                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                    const id = overrides[opt] ?? cfg.id;
                    if (!isValidSheetId(id)) return;

                    try {
                        const { cols, items: rows } = await fetchSheetData(id, cfg.sheet);
                        const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);
                        const regionCol = findColumnByCandidates(cols, REGION_CANDIDATES);

                        if (!raqamCol || !regionCol) return;
                        
                        rows.forEach((r) => {
                            const region = r[regionCol] ? String(r[regionCol]).trim() : null;
                            const n = parseNumericValue(r[raqamCol]);
                            if (region && !Number.isNaN(n)) {
                                if (!regionTotals[region]) regionTotals[region] = 0;
                                regionTotals[region] += n;
                            }
                        });
                    } catch (err) {
                        console.error(`Error fetching region data for ${opt}:`, err);
                    }
                });

                try {
                    await Promise.all(fetchPromises);
                    const finalRegionData = {};
                    for (const region in regionTotals) {
                        finalRegionData[region] = {
                            totalAmount: regionTotals[region],
                            totalUnit: regionTotals[region] / UNIT_DIVISOR
                        };
                    }
                    setRegionData(finalRegionData);
                } catch (e) {
                    setRegionError("Sabhi region data ko process nahi kiya ja saka.");
                } finally {
                    setRegionLoading(false);
                }
            }

            // This is the main polling/timer effect that controls what happens for each tab.
            useEffect(() => {
                let pollId;

                const actionMap = {
                    "Overall Rank": loadOverallRank,
                    "Region Competition": loadRegionData,
                    "Result": loadAllResults,
                    "Default": loadActiveSheet,
                };
                const currentAction = actionMap[active] || actionMap["Default"];
                
                const { id } = getActiveConfig();
                if (active !== "Result" && active !== "Overall Rank" && active !== "Region Competition" && !isValidSheetId(id)) {
                     setData({ items: [] });
                     setError(null);
                     setLoading(false);
                     setIsDataLoaded(true);
                } else {
                    currentAction();
                    pollId = setInterval(currentAction, POLL_INTERVAL_MS);
                }
                
                return () => {
                    if (pollId) clearInterval(pollId);
                };
            }, [active, overrides]);

            // This effect handles the countdown timer for the Result tab
            useEffect(() => {
                 if (targetDate) {
                    const timer = setInterval(() => {
                        const remaining = calculateTimeRemaining(targetDate);
                        setCountdown(remaining);
                    }, 1000);
                    return () => clearInterval(timer);
                }
            }, [targetDate]);
            
            const ustazLabel = active === 'Takhassusat' ? 'Jamia Name' : 'Ustaz Name';
            const jamiaLabel = active === 'Takhassusat' ? 'Class' : 'Jamia Name';

            const showFullScreenLoader = (isLoading && !isDataLoaded) || 
                                         (active === "Overall Rank" && isRankLoading && !isRankDataLoaded) ||
                                         (active === "Region Competition" && isRegionLoading && Object.keys(regionData).length === 0);
            
            const classesForTop10 = ["Ibtidaiya", "Sale Awwal", "Sale Duwam", "Ula", "Saniya", "Salisa", "Rabia", "Khamisa"];
            const classesForTop3 = ["Sadisa", "Sabia", "Doratul Hadis", "Takhassusat", "Darulifta Ahle Sunnat"];
            const classesForFullList = ["Khamisa", "Sadisa", "Sabia", "Doratul Hadis", "Takhassusat", "Darulifta Ahle Sunnat"];
            
            const DownloadIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                  <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
            );

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Poster component is rendered off-screen when needed */}
                    {posterData && posterData.type === 'podium3' && ReactDOM.createPortal(<Podium3Poster data={posterData} />, posterContainerRef.current)}
                    {posterData && posterData.type === 'podium5' && ReactDOM.createPortal(<Podium5Poster data={posterData} />, posterContainerRef.current)}
                    {posterData && posterData.type === 'podium10' && ReactDOM.createPortal(<Podium10Poster data={posterData} />, posterContainerRef.current)}
                    {posterData && posterData.type === 'list' && ReactDOM.createPortal(<ListPoster data={posterData} />, posterContainerRef.current)}
                    {posterData && posterData.type === 'overall' && ReactDOM.createPortal(<OverallRankPoster data={posterData} />, posterContainerRef.current)}
                    {posterData && posterData.type === 'pdf' && ReactDOM.createPortal(<PdfResultPoster data={posterData} />, posterContainerRef.current)}

                    <div className="max-w-7xl mx-auto p-4 sm:p-6">
                        <header className="mb-6 text-center">
                            <h1 className="text-6xl sm:text-7xl font-['Bebas_Neue'] bg-clip-text text-transparent bg-gradient-to-r from-sky-500 to-indigo-600">
                                TELETHON 2025
                            </h1>
                            <p className="text-sm text-slate-500 mt-1">Jamia-tul-Madina India Class/Jamia Wise Positions</p>
                        </header>

                        <nav className="mb-4">
                            <div className="hidden md:flex flex-wrap gap-2 justify-center">
                                {allOptions.map((opt) => (
                                    <button
                                        key={opt}
                                        onClick={() => setActive(opt)}
                                        className={`px-3 py-2 rounded-2xl font-medium text-sm shadow-sm focus:outline-none transition-transform transform hover:-translate-y-0.5 ${ active === opt ? "bg-sky-600 text-white shadow-lg" : "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50" }`}
                                    >
                                        <span>{opt}</span>
                                    </button>
                                ))}
                            </div>

                            <div className="md:hidden">
                                <select value={active} onChange={(e) => setActive(e.target.value)} className="block w-full px-3 py-2 rounded-lg bg-white border border-slate-300 text-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 shadow-sm">
                                    {allOptions.map((opt) => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>
                        </nav>
                        
                        <div className="flex flex-col items-center justify-center p-3 bg-indigo-50 rounded-xl shadow-md mb-4 border border-indigo-200">
                            <h2 className="text-2xl font-['Bowlby_One_SC'] text-indigo-900 text-center uppercase">{active === 'Result' ? 'Result (Quarter Final Competition)' : active}</h2>
                        </div>

                        <main className="relative">
                            {showFullScreenLoader && (
                                <div className="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex justify-center items-center rounded-lg shadow-xl">
                                    <div className="text-xl text-slate-500 flex flex-col items-center p-8 bg-white border rounded-xl shadow-lg">
                                        <div className="loader w-10 h-10 mb-4 border-t-sky-500 border-4"></div>
                                        Loading...
                                    </div>
                                </div>
                            )}

                            {active === "Overall Rank" ? (
                                <div className="bg-white border rounded-lg p-4 shadow-lg relative">
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <h2 className="text-xl md:text-2xl font-bold text-slate-800">All India Classic Rank</h2>
                                        <div className="flex items-center gap-2">
                                            <button 
                                                onClick={handleDownloadOverallRankPoster}
                                                disabled={isDownloading || overallRankData.length === 0}
                                                className="p-2 text-white bg-indigo-500 rounded-lg shadow-sm hover:bg-indigo-600 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-1.5"
                                                title="Download Overall Rank Poster"
                                            >
                                                {isDownloading ? <div className="loader !w-4 !h-4 !border-2 !border-t-white"></div> : <DownloadIcon />}
                                            </button>
                                            <LiveClock />
                                        </div>
                                    </div>
                                    {rankError && <div className="text-sm text-rose-600 mb-4 p-2 border border-rose-300 bg-rose-50 rounded-lg">Error: {rankError}</div>}
                                    <div className="hidden md:grid grid-cols-12 items-center px-3 py-2 border-b text-sm font-semibold text-slate-700 bg-slate-50 rounded-t-lg">
                                        <div className="col-span-1">Rank</div>
                                        <div className="col-span-5">Class Name</div>
                                        <div className="col-span-3 text-center">Calculated Unit</div>
                                        <div className="col-span-3 text-right">Total Amount</div>
                                    </div>
                                    <div className="space-y-3 mt-1">
                                        {overallRankData.map((item, idx) => (
                                            <div key={item.className} className={`rank-item grid grid-cols-12 items-center p-3 md:p-4 rounded-xl shadow-sm border ${idx === 0 ? "bg-yellow-50 border-yellow-400 shadow-lg" : "bg-white border-slate-200 hover:shadow-md"}`}>
                                                <div className="col-span-1 text-base md:text-2xl font-['Bebas_Neue'] text-center text-slate-800">{idx + 1}</div>
                                                <div className="col-span-5 md:ml-4 flex-grow truncate">
                                                    <div className={`text-base md:text-lg font-bold ${idx === 0 ? "text-yellow-700" : "text-slate-800"}`}>
                                                        {item.className}
                                                        <span className="ml-1 text-lg md:text-2xl">{medalForIndex(idx)}</span>
                                                    </div>
                                                    {item.error ? <div className="text-xs text-rose-500 mt-1">Error: {item.error}</div> : <div className="hidden md:block text-xs text-slate-500">Class Rank</div>}
                                                </div>
                                                <div className="col-span-3 text-center md:text-xl font-['Bebas_Neue'] text-indigo-500 tracking-wider">
                                                    <span className="md:hidden text-xs text-slate-500 block mb-[-2px]">Unit</span>
                                                    {formatOverallUnit(item.totalAmount)}
                                                </div>
                                                <div className={`col-span-3 text-right md:text-2xl font-['Bebas_Neue'] ${idx === 0 ? "text-emerald-700" : "text-indigo-600"} tracking-wide min-w-[50px]`}>
                                                    <span className="md:hidden text-xs text-slate-500 block mb-[-2px]">Amount</span>
                                                    {item.totalAmount.toLocaleString()}
                                                </div>
                                            </div>
                                        ))}
                                        {overallRankData.length === 0 && !isRankLoading && <div className="text-center p-4 text-slate-500">No data available.</div>}
                                    </div>
                                </div>
                            ) : active === "Result" ? (
                                <div className="bg-white border rounded-lg p-6 text-center shadow-lg">
                                    
                                    {targetDate ? (
                                        <>
                                            <h2 className="text-3xl font-extrabold text-slate-800 mb-4">{resultPageHeading}</h2>
                                            {!countdown.expired ? (
                                                <>
                                                    <div className="text-xl font-medium text-slate-600 mb-6">Results will be announced at {targetDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true })}!</div>
                                                    <div className="flex justify-center items-end gap-4 md:gap-8 font-bold">
                                                        {Object.entries({ Days: countdown.days, Hours: countdown.hours, Minutes: countdown.minutes, Seconds: countdown.seconds }).map(([label, value]) => (
                                                            <div key={label} className="flex flex-col items-center p-4 bg-sky-100 rounded-xl min-w-[70px] shadow-lg">
                                                                <span className="text-4xl md:text-5xl text-sky-700">{String(value).padStart(2, '0')}</span>
                                                                <span className="text-sm md:text-base text-slate-500">{label}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="flex justify-center items-center gap-4 mb-4">
                                                        <div className="text-3xl font-bold text-emerald-600">Results Announced!</div>
                                                        <button onClick={handleDownloadPdfResult} disabled={isDownloading} className="p-2 text-white bg-green-600 rounded-lg shadow-sm hover:bg-green-700 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-1.5" title="Download Full Result PDF">
                                                            {isDownloading ? <div className="loader !w-4 !h-4 !border-2 !border-t-white"></div> : <><DownloadIcon /> <span className="text-xs font-bold">PDF</span></>}
                                                        </button>
                                                    </div>
                                                    {(isResultLoading && Object.keys(resultData).length === 0) ? <div className="text-sm text-slate-500 animate-pulse">Loading Results...</div> : Object.keys(resultData).length > 0 ? (
                                                        <>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                                {Object.keys(resultData).map(className => (
                                                                    <div key={className} className="bg-gray-50 border border-gray-200 p-4 rounded-xl shadow-sm flex flex-col">
                                                                        <div className="flex justify-between items-center mb-3 border-b pb-2">
                                                                            <h3 className="text-xl font-bold text-slate-700">{className} Winners</h3>
                                                                            <div className="flex items-center gap-2">
                                                                                <button onClick={() => handleDownloadTop3PodiumPoster(className, resultData[className])} title="Download Top 3 Podium Poster" disabled={isDownloading || resultData[className].length < 3} className="p-2 text-white bg-sky-500 rounded-lg shadow-sm hover:bg-sky-600 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-1.5">
                                                                                    {isDownloading ? <div className="loader !w-4 !h-4 !border-2 !border-t-white"></div> : <><DownloadIcon /> <span className="text-xs font-bold">T3</span></>}
                                                                                </button>
                                                                                <button onClick={() => handleDownloadTop5PodiumPoster(className, resultData[className])} title="Download Top 5 Podium Poster" disabled={isDownloading || resultData[className].length < 5} className="p-2 text-white bg-indigo-500 rounded-lg shadow-sm hover:bg-indigo-600 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-1.5">
                                                                                    {isDownloading ? <div className="loader !w-4 !h-4 !border-2 !border-t-white"></div> : <><DownloadIcon /> <span className="text-xs font-bold">T5</span></>}
                                                                                </button>
                                                                                <button onClick={() => handleDownloadTop10PodiumPoster(className, resultData[className])} title="Download Top 10 Podium Poster" disabled={isDownloading || resultData[className].length < 10} className="p-2 text-white bg-teal-500 rounded-lg shadow-sm hover:bg-teal-600 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-1.5">
                                                                                    {isDownloading ? <div className="loader !w-4 !h-4 !border-2 !border-t-white"></div> : <><DownloadIcon /> <span className="text-xs font-bold">T10</span></>}
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <div className="space-y-4 flex-grow">
                                                                            {resultData[className].slice(0, 3).map((item, index) => (
                                                                                <div key={index} className={`p-4 rounded-xl text-center transition-all duration-300 shadow-md ${index === 0 ? "bg-gradient-to-br from-amber-100 to-yellow-200 border-amber-300" : "bg-gradient-to-br from-slate-50 to-gray-100 border-slate-200"} border`}>
                                                                                    <img
                                                                                        src={item.photoUrl || 'https://placehold.co/200x200/e2e8f0/64748b?text=Photo'}
                                                                                        onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/200x200/e2e8f0/64748b?text=Error'; }}
                                                                                        alt={`Winner ${item.jamia}`}
                                                                                        className="w-32 h-32 md:w-40 md:h-40 mx-auto rounded-full object-cover border-8 border-white shadow-xl mb-4"
                                                                                    />
                                                                                    <div className="flex-grow text-center">
                                                                                        <p className={`text-xl font-bold ${index === 0 ? 'text-amber-800' : 'text-slate-800'}`}>{item.jamia}</p>
                                                                                        <p className="text-md text-slate-500 mb-3">{item.ustaz}</p>
                                                                                    </div>
                                                                                    <div className={`inline-flex items-center justify-center p-3 rounded-lg ${index === 0 ? 'bg-amber-200' : 'bg-slate-200'}`}>
                                                                                        <span className="text-4xl mr-3">{medalForIndex(index)}</span>
                                                                                        <div>
                                                                                             <span className="font-extrabold text-3xl font-['Bebas_Neue'] tracking-wider text-indigo-700">{item.unit}</span>
                                                                                             <span className="block text-xs text-slate-600 -mt-1">UNITS</span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </>
                                                    ) : <div className="text-sm text-slate-500 mt-2">No results found.</div>}
                                                </>
                                            )}
                                        </>
                                    ) : (
                                         <div className="text-lg font-medium text-slate-500">Countdown time not set.</div>
                                    )}
                                </div>
                            ) : active === "Region Competition" ? (
                                <RegionCompetitionView regionData={regionData} isLoading={isRegionLoading} error={regionError} />
                            ) : (
                                <div className="bg-white border rounded-lg p-4 shadow-lg relative">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-bold text-slate-700">Live Rankings</h2>
                                        <div className="flex items-center gap-2">
                                            {classesForTop10.includes(active) && (
                                                <>
                                                    <button onClick={() => handleDownloadClassPoster(5)} title="Download Top 5 Poster" disabled={isDownloading || data.items.length === 0} className="p-2 text-white bg-indigo-500 rounded-lg shadow-sm hover:bg-indigo-600 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-1.5">
                                                        {isDownloading ? <div className="loader !w-4 !h-4 !border-2 !border-t-white"></div> : <><DownloadIcon /> <span className="text-xs font-bold">T5</span></>}
                                                    </button>
                                                    <button onClick={() => handleDownloadClassPoster(10)} title="Download Top 10 Poster" disabled={isDownloading || data.items.length === 0} className="p-2 text-white bg-indigo-500 rounded-lg shadow-sm hover:bg-indigo-600 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-1.5">
                                                        {isDownloading ? <div className="loader !w-4 !h-4 !border-2 !border-t-white"></div> : <><DownloadIcon /> <span className="text-xs font-bold">T10</span></>}
                                                    </button>
                                                </>
                                            )}
                                             {classesForTop3.includes(active) && (
                                                 <button onClick={() => handleDownloadClassPoster(3)} title="Download Top 3 Poster" disabled={isDownloading || data.items.length === 0} className="p-2 text-white bg-indigo-500 rounded-lg shadow-sm hover:bg-indigo-600 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-1.5">
                                                    {isDownloading ? <div className="loader !w-4 !h-4 !border-2 !border-t-white"></div> : <><DownloadIcon /> <span className="text-xs font-bold">T3</span></>}
                                                </button>
                                            )}
                                            {classesForFullList.includes(active) && (
                                                <button onClick={handleDownloadFullListPoster} title="Download Full List Poster" disabled={isDownloading || data.items.length === 0} className="p-2 text-white bg-purple-600 rounded-lg shadow-sm hover:bg-purple-700 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-1.5">
                                                    {isDownloading ? <div className="loader !w-4 !h-4 !border-2 !border-t-white"></div> : <><DownloadIcon /> <span className="text-xs font-bold">FULL</span></>}
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                    {!isValidSheetId(getActiveConfig().id) && (
                                        <div className="mb-4 p-4 border rounded-xl bg-red-50 border-red-200">
                                            <div className="text-sm font-semibold text-red-700 mb-2">Sheet not configured. Paste Google Sheet URL or ID.</div>
                                            <form onSubmit={(e) => { e.preventDefault(); const id = parseSheetIdFromUrl(sheetInput); if(id) setOverrides(p => ({...p, [active]: id})); setSheetInput(''); }} className="flex gap-2">
                                                <input value={sheetInput} onChange={(e) => setSheetInput(e.target.value)} placeholder="Google Sheet URL or Sheet ID" className="flex-1 px-3 py-2 border rounded-lg focus:ring-sky-500"/>
                                                <button type="submit" className="px-4 py-2 rounded-lg bg-sky-600 text-white font-medium">Set Sheet</button>
                                            </form>
                                            {error && <div className="text-sm text-rose-600 mt-2">Error: {error}</div>}
                                        </div>
                                    )}
                                    {error && isValidSheetId(getActiveConfig().id) && <div className="text-sm text-rose-600 mb-4 p-2 border border-rose-300 bg-rose-50 rounded-lg">Error: {error}</div>}
                                    <div className={`relative ${showFullScreenLoader ? 'opacity-50 pointer-events-none' : ''}`}>
                                        <div className="hidden md:block">
                                            <div className="grid grid-cols-12 items-center px-3 py-2 border-b text-sm font-semibold text-slate-700 bg-slate-50 rounded-t-lg">
                                                <div className="col-span-1">Rank</div>
                                                <div className="col-span-2">{ustazLabel}</div>
                                                <div className="col-span-4 text-center">{jamiaLabel}</div>
                                                <div className="col-span-3 text-right">Raqam</div>
                                                <div className="col-span-2 text-right">Unit</div>
                                            </div>
                                            <div className="space-y-1 mt-1">
                                                {data.items.map((it, idx) => {
                                                    const styleClass = idx === 0 ? "bg-yellow-50 border-yellow-300 shadow-md" : idx === 1 ? "bg-sky-50 border-sky-300" : idx === 2 ? "bg-emerald-50 border-emerald-300" : "bg-white border-transparent hover:bg-slate-50";
                                                    return (
                                                        <div key={it.__id} className={`grid grid-cols-12 items-center gap-4 p-3 rounded-lg transition-all duration-600 ${styleClass} ${it.__id === highlightKey ? "highlight-pulse" : ""}`}>
                                                            <div className="col-span-1 font-bold text-base">{idx + 1}</div>
                                                            <div className="col-span-2 text-left text-sm font-medium">{active === 'Takhassusat' ? (it.jamia || "-") : (it.ustaz || "-")}</div>
                                                            <div className={`col-span-4 text-center font-bold ${idx === 0 ? 'text-xl' : 'text-lg'}`}><span className="inline-flex items-center gap-2">{medalForIndex(idx)}<span>{active === 'Takhassusat' ? it.ustaz : it.jamia}</span></span></div>
                                                            <div className="col-span-3 text-right text-xl font-bold">{it.__value.toLocaleString()}</div>
                                                            <div className="col-span-2 text-right text-lg font-['Bebas_Neue'] text-indigo-600 tracking-wider">{it.unit || "-"}</div>
                                                        </div>
                                                    );
                                                })}
                                                {data.items.length === 0 && !isLoading && <div className="text-sm text-slate-500 p-3 text-center">No valid rows found.</div>}
                                            </div>
                                        </div>
                                        <div className="md:hidden space-y-3">
                                            {data.items.map((it, idx) => (
                                                <div key={it.__id} className={`p-4 rounded-lg shadow-sm ${idx === 0 ? "bg-yellow-50 border-yellow-300" : "bg-white border-slate-100"} ${it.__id === highlightKey ? "highlight-pulse" : ""}`}>
                                                    <div className="flex items-center justify-between border-b pb-2 mb-2">
                                                        <div className="text-xl font-bold text-slate-800 flex items-center gap-2"><span>{idx + 1}.</span><span className="truncate max-w-[200px]">{active === 'Takhassusat' ? it.ustaz : it.jamia}</span><span>{medalForIndex(idx)}</span></div>
                                                        <div className="text-xl font-bold text-right">{it.__value.toLocaleString()}</div>
                                                    </div>
                                                    <div className="text-sm text-slate-600 flex justify-between">
                                                        <div className="truncate mr-4"><span className="font-semibold">{ustazLabel}:</span> {active === 'Takhassusat' ? (it.jamia || "-") : (it.ustaz || "-")}</div>
                                                        <div><span className="font-semibold">Unit:</span> <span className="font-['Bebas_Neue'] font-bold text-lg text-indigo-600">{it.unit || "-"}</span></div>
                                                    </div>
                                                </div>
                                            ))}
                                            {data.items.length === 0 && !isLoading && <div className="text-sm text-slate-500 p-3 text-center">No valid rows found.</div>}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>

                        <footer className="mt-8 text-xs text-slate-500 text-center">Made with â¤ï¸ â€” Majlis Talimi Umoor India</footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><TelethoneEnhancedLive /></React.StrictMode>);
    </script>

</body>
</html>

