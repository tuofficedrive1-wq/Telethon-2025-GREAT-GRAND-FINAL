<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telethone 2025 Live Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bowlby+One+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Fredoka+One&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
        }
        /* Custom CSS for top 3 rows highlight animation */
        .highlight-pulse {
            animation: pulse-ring 0.6s cubic-bezier(0, 0, 0.2, 1) forwards;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.4);
            }
            100% {
                transform: scale(1.02);
                box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
            }
        }

        /* Custom CSS for Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Blue 500 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* NEW: Custom CSS for smooth transitions on rank items */
        .rank-item {
            /* Smooth transition for position changes */
            transition: all 0.5s ease-in-out;
            will-change: transform, box-shadow;
        }
        
        /* NEW: Animation for the heading */
        .heading-anim {
            animation: float-pop 3s ease-in-out infinite;
        }

        @keyframes float-pop {
            0%, 100% {
                transform: translateY(0) scale(1);
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            50% {
                transform: translateY(-8px) scale(1.05);
                text-shadow: 0 8px 16px rgba(0,0,0,0.2);
            }
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="root"></div>
    
    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- Utility Functions ---
        // --- Live Clock Component ---
        const LiveClock = () => {
            const [time, setTime] = useState(new Date());

            useEffect(() => {
                const timerId = setInterval(() => {
                    setTime(new Date());
                }, 1000);

                return () => clearInterval(timerId);
            }, []);

            return (
                <div className="text-sm font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-lg shadow-inner">
                    {time.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}
                </div>
            );
        };
        
        // --- Google Sheet Configuration and Logic ---
        
        const DEFAULT_SHEET_CONFIGS = {
            // Class Wise
            "Ibtidaiya": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Ibtidaiya" },
            "Sale Awwal": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sale Awwal" },
            "Sale Duwam": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sale Duwam" },
            "Ula": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Ula" },
            "Saniya": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Saniya" },
            "Salisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Salisa" },
            "Rabia": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Rabia" },
            "Khamisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Khamisa" },
            "Sadisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sadisa" },
            "Sabia": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sabia" },
            "Doratul Hadis": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Daurul Hadis" },
            "Takhassusat": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Takhassusat" },
            "Darulifta Ahle Sunnat": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Darul Ifta" },
            
            // Jamia/Overall Wise Rank
            "Overall Class Rank": { id: null, sheet: null }, // This is for the overall class rank view, not a sheet
            "Jamia-tul-Madina": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "JAMIA" },
            "Madrasa-tul-Madina": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "M" }, 
            "Darul-Madina": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "D" },
            "Top 10 Department": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "DE" },
            "Top 10 States": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "S" },
        };

        const POLL_INTERVAL_MS = 5000;
        const LOCALSTORAGE_KEY = "telethone_sheet_overrides_enhanced_live";
        const UNIT_DIVISOR = 7000;
        
        function parseSheetIdFromUrl(input) {
            if (!input) return null;
            input = input.trim();
            const m = input.match(/\/d\/([a-zA-Z0-9-_]{10,})/);
            if (m) return m[1];
            const m2 = input.match(/\/spreadsheets\/d\/e?\/(?:pubhtml\/)?([a-zA-Z0-9-_]{10,})/);
            if (m2) return m2[1];
            if (/^[a-zA-Z0-9-_]{10,}$/.test(input)) return input;
            return null;
        }

        function isValidSheetId(id) {
            return Boolean(id && /^[a-zA-Z0-9-_]{10,}$/.test(id));
        }

        function gvizUrl(sheetId, sheetName) {
            return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        }

        async function fetchSheetData(sheetId, sheetName) {
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const url = gvizUrl(sheetId, sheetName);
                    const res = await fetch(url, { cache: "no-cache" });
                    
                    if (res.status === 429) { 
                        if (attempt < 2) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error("Too many requests to Google Sheets API.");
                    }

                    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
                    const text = await res.text();

                    let jsonText = null;
                    const match = text.match(/setResponse\(([\s\S]*)\);?\s*$/);
                    if (match && match[1]) jsonText = match[1];
                    else {
                        const first = text.indexOf('{');
                        const last = text.lastIndexOf('}');
                        if (first !== -1 && last !== -1 && last > first) jsonText = text.slice(first, last + 1);
                    }

                    if (!jsonText) throw new Error('Could not extract JSON from GViz response; sheet may not be published or allowed.');

                    let data;
                    try {
                        data = JSON.parse(jsonText);
                    } catch (err) {
                        throw new Error('Failed to parse GViz JSON ‚Äî ' + err.message);
                    }

                    const cols = (data.table.cols || []).map((c, i) => (c.label || c.id || `col${i}`).toString());
                    const rows = (data.table.rows || []).map((r) => r.c.map((cell) => (cell ? (cell.f !== undefined ? cell.f : cell.v) : null)));
                    const items = rows.map((r) => {
                        const obj = {};
                        cols.forEach((k, i) => (obj[k || `col${i}`] = r[i]));
                        return obj;
                    });
                    return { cols, items };

                } catch (error) {
                    if (attempt === 2) throw error;
                    if (error.message.includes("Too many requests")) throw error;
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Failed to fetch sheet data after multiple retries.");
        }

        const USTAZ_CANDIDATES = ["Ustaz Name", "USTAZ NAME", "Ustaz", "Ustad", "Instructor", "Teacher", "Class"];
        const JAMIA_CANDIDATES = ["Jamia Name", "JAMIA NAME", "Jamia", "Jamiah", "Campus Name", "Campus"];
        const RAQAM_CANDIDATES = ["Raqam", "RAQAM", "Amount", "Value", "‡§∞‡§ï‡§Æ", "‡§∞‡§æ‡§∂‡§ø"];
        const UNIT_CANDIDATES = ["Unit", "UNIT", "Units"];
        const NAME_CANDIDATES = ["Name", "name"];
        const REGION_CANDIDATES = ["Region", "REGION", "Zone"];
        const STATE_CANDIDATES = ["State", "STATE"];
        const DEPARTMENT_CANDIDATES = ["Department", "DEPARTMENT"];


        function findColumnByCandidates(cols, candidates) {
            if (!candidates) return null;
            const lower = cols.map((c) => (c || "").toLowerCase().trim());
            for (let cand of candidates) {
                const target = cand.toLowerCase().trim();
                const idx = lower.findIndex((c) => c === target);
                if (idx >= 0) return cols[idx];
            }
            for (let cand of candidates) {
                const token = cand.toLowerCase().trim();
                const idx = lower.findIndex((c) => c.includes(token));
                if (idx >= 0) return cols[idx];
            }
            return null;
        }

        function medalForIndex(i) {
            if (i === 0) return "ü•á";
            if (i === 1) return "ü•à";
            if (i === 2) return "ü•â";
            return "";
        }
        
        function parseNumericValue(value) {
            if (value === null || value === undefined || String(value).trim() === "") {
                return NaN;
            }
            const cleaned = String(value).replace(/[^0-9.-]+/g, "");
            const n = Number(cleaned);
            return Number.isNaN(n) ? NaN : n;
        }

        const RANKING_VIEW_CONFIG = {
            // Class Wise
            "Ibtidaiya": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Sale Awwal": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Sale Duwam": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Ula": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Saniya": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Salisa": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Rabia": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Khamisa": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Sadisa": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Sabia": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Doratul Hadis": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Takhassusat": { nameLabel: "Jamia Name", categoryLabel: "Class", nameColCandidates: JAMIA_CANDIDATES, categoryColCandidates: USTAZ_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            "Darulifta Ahle Sunnat": { nameLabel: "Ustaz Name", categoryLabel: "Jamia Name", nameColCandidates: USTAZ_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: RAQAM_CANDIDATES, valueIsUnit: false },
            // Competitions
            "Jamia-tul-Madina": { nameLabel: "Name", categoryLabel: "Jamia Name", nameColCandidates: NAME_CANDIDATES, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: UNIT_CANDIDATES, valueIsUnit: true },
            "Madrasa-tul-Madina": { nameLabel: null, categoryLabel: "State", nameColCandidates: null, categoryColCandidates: STATE_CANDIDATES, valueColCandidates: UNIT_CANDIDATES, valueIsUnit: true },
            "Darul-Madina": { nameLabel: null, categoryLabel: "Campus Name", nameColCandidates: null, categoryColCandidates: JAMIA_CANDIDATES, valueColCandidates: UNIT_CANDIDATES, valueIsUnit: true },
            "Top 10 Department": { nameLabel: null, categoryLabel: "Department", nameColCandidates: null, categoryColCandidates: DEPARTMENT_CANDIDATES, valueColCandidates: UNIT_CANDIDATES, valueIsUnit: true },
            "Top 10 States": { nameLabel: null, categoryLabel: "State", nameColCandidates: null, categoryColCandidates: STATE_CANDIDATES, valueColCandidates: UNIT_CANDIDATES, valueIsUnit: true },
        };
        
        function TelethoneEnhancedLive() {
            const TAB_CONFIG = {
                "Jamia Tul Madina Class Wise Rank": {
                    subTabs: [
                        "Ibtidaiya", "Sale Awwal", "Sale Duwam", "Ula", "Saniya", "Salisa", "Rabia", "Khamisa", "Sadisa", "Sabia", "Doratul Hadis", "Takhassusat", "Darulifta Ahle Sunnat",
                        "Overall Class Rank"
                    ],
                    defaultSubTab: "Ibtidaiya",
                },
                "Competitions": { 
                    subTabs: ["Jamia-tul-Madina", "Madrasa-tul-Madina", "Darul-Madina", "Top 10 Department", "Top 10 States"],
                    defaultSubTab: "Jamia-tul-Madina",
                }
            };

            const MAIN_TABS = Object.keys(TAB_CONFIG);

            const [mainActive, setMainActive] = useState("Jamia Tul Madina Class Wise Rank");
            const [subActive, setSubActive] = useState("Ibtidaiya"); 
            
            const [overrides, setOverrides] = useState(() => {
                try {
                    const raw = localStorage.getItem(LOCALSTORAGE_KEY);
                    if (raw) return JSON.parse(raw);
                } catch (e) {}
                const out = {};
                for (let k of Object.keys(DEFAULT_SHEET_CONFIGS)) if (DEFAULT_SHEET_CONFIGS[k].id) out[k] = DEFAULT_SHEET_CONFIGS[k].id;
                return out;
            });

            useEffect(() => {
                try {
                    localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(overrides));
                } catch (e) {}
            }, [overrides]);

            const [data, setData] = useState({ items: [] });
            const [isLoading, setLoading] = useState(true); 
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [error, setError] = useState(null);
            const [sheetInput, setSheetInput] = useState("");
            const [highlightKey, setHighlightKey] = useState(null);
            
            const [overallRankData, setOverallRankData] = useState([]);
            const [isRankLoading, setRankLoading] = useState(true);
            const [isRankDataLoaded, setIsRankDataLoaded] = useState(false);
            const [rankError, setRankError] = useState(null);

            useEffect(() => {
                if (mainActive === "Jamia Tul Madina Class Wise Rank" && subActive === "Overall Class Rank") {
                    loadOverallRank();
                }
            }, [mainActive, subActive]);
            
            function getActiveConfig() {
                const cfg = DEFAULT_SHEET_CONFIGS[subActive] || { id: "", sheet: "Sheet1" };
                const id = overrides[subActive] ?? cfg.id ?? "";
                return { id, sheet: cfg.sheet || subActive || "Sheet1" };
            }

            async function loadActiveSheet() {
                const { id, sheet } = getActiveConfig();
                
                if (!isValidSheetId(id)) {
                    setData({ items: [] });
                    setError(null);
                    setLoading(false);
                    return;
                }

                setLoading(true);
                setError(null);
                try {
                    const { cols, items: rows } = await fetchSheetData(id, sheet);
                    const currentViewConfig = RANKING_VIEW_CONFIG[subActive];
                    if (!currentViewConfig) {
                        setError(`Configuration for "${subActive}" not found.`);
                        setLoading(false);
                        setData({ items: [] });
                        return;
                    }

                    const nameCol = findColumnByCandidates(cols, currentViewConfig.nameColCandidates);
                    const categoryCol = findColumnByCandidates(cols, currentViewConfig.categoryColCandidates);
                    const valueCol = findColumnByCandidates(cols, currentViewConfig.valueColCandidates);

                    if (!categoryCol || !valueCol) {
                        setError(`Sheet mein '${currentViewConfig.categoryLabel}' aur '${currentViewConfig.valueColCandidates === UNIT_CANDIDATES ? 'Unit' : 'Raqam'}' ke headers hone chahiye.`);
                        setData({ items: [] });
                        setLoading(false);
                        setIsDataLoaded(true);
                        return;
                    }

                    const parsed = rows
                        .map((r, idx) => ({ 
                            __id: idx,
                            name: nameCol ? String(r[nameCol] || "").trim() : "",
                            category: String(r[categoryCol] || "").trim(), 
                            __value: parseNumericValue(r[valueCol]),
                        }))
                        .filter((x) => x.category !== "" && !Number.isNaN(x.__value));

                    parsed.sort((a, b) => b.__value - a.__value);
                    
                    const newTopId = parsed.length ? parsed[0].__id : null;
                    if (newTopId !== null && newTopId !== highlightKey) {
                        setHighlightKey(newTopId);
                        setTimeout(() => setHighlightKey(null), 1200);
                    }

                    setData({ items: parsed });
                } catch (err) {
                    console.error(err);
                    setError(err.message || String(err));
                    setData({ items: [] });
                } finally {
                    setLoading(false);
                    setIsDataLoaded(true);
                }
            }
            
            async function loadOverallRank() {
                setRankLoading(true);
                setRankError(null);
                const sheetOptions = TAB_CONFIG["Jamia Tul Madina Class Wise Rank"].subTabs.filter(tab => tab !== "Darulifta Ahle Sunnat" && tab !== "Overall Class Rank");
                
                const fetchPromises = sheetOptions.map(async (opt) => {
                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                    const id = overrides[opt] ?? cfg.id;
                    if (!isValidSheetId(id)) return { className: opt, totalAmount: 0, error: "Not Configured" };

                    try {
                        const { cols, items: rows } = await fetchSheetData(id, cfg.sheet);
                        const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);
                        if (!raqamCol) return { className: opt, totalAmount: 0, error: "Missing Raqam Column" };
                        
                        let totalAmount = 0;
                        rows.forEach((r) => {
                            const n = parseNumericValue(r[raqamCol]);
                            totalAmount += Number.isNaN(n) ? 0 : n;
                        });
                        
                        return { className: opt, totalAmount, error: null };
                    } catch (err) {
                        return { className: opt, totalAmount: 0, error: err.message };
                    }
                });

                try {
                    const results = await Promise.all(fetchPromises);
                    const validResults = results.filter(r => r.totalAmount > 0 || (r.error && r.error.includes("Missing Raqam Column")));
                    setOverallRankData(validResults.sort((a, b) => b.totalAmount - a.totalAmount));
                } catch (e) {
                    setRankError("Sabhi rank data ko process nahi kiya ja saka.");
                } finally {
                     setRankLoading(false);
                     setIsRankDataLoaded(true);
                }
            }
            
            // This is the main polling/timer effect that controls what happens for each tab.
            useEffect(() => {
                let pollId;
                let actionToRun = () => {};
                
                if (mainActive === 'Jamia Tul Madina Class Wise Rank' && subActive === 'Overall Class Rank') {
                    actionToRun = loadOverallRank;
                } else {
                    actionToRun = loadActiveSheet;
                }
                
                const { id } = getActiveConfig();
                const isRankingsView = mainActive === 'Jamia Tul Madina Class Wise Rank' || mainActive === 'Competitions';
                
                if ( (isRankingsView && subActive !== 'Overall Class Rank' && !isValidSheetId(id)) ) {
                     setData({ items: [] });
                     setError(null);
                     setLoading(false);
                     setIsDataLoaded(true);
                } else {
                    actionToRun();
                    pollId = setInterval(actionToRun, POLL_INTERVAL_MS);
                }
                
                return () => {
                    if (pollId) clearInterval(pollId);
                };
            }, [mainActive, subActive, overrides]);
            
            const handleMainTabClick = (tab) => {
                setMainActive(tab);
                if (TAB_CONFIG[tab].defaultSubTab) {
                    setSubActive(TAB_CONFIG[tab].defaultSubTab);
                }
            };

            const pageTitle = TAB_CONFIG[mainActive].subTabs.length > 0 ? subActive : mainActive;

            const showFullScreenLoader = (isLoading && !isDataLoaded) || 
                                         (mainActive === "Jamia Tul Madina Class Wise Rank" && subActive === 'Overall Class Rank' && isRankLoading && !isRankDataLoaded) ||
                                         (mainActive === "Competitions" && isLoading && data.items.length === 0);
            
            
            const RankingsView = () => {
                 const currentViewConfig = RANKING_VIEW_CONFIG[subActive];
                 if (!currentViewConfig) return <div className="p-4 text-center text-rose-500">Error: No configuration found for {subActive}.</div>;
                 const { nameLabel, categoryLabel } = currentViewConfig;
                 const isSimpleView = !currentViewConfig.nameLabel;

                 return (
                     <div className="bg-white border border-gray-200 rounded-xl p-4 shadow-sm relative">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-gray-700">Live Rankings</h2>
                        </div>
                        {!isValidSheetId(getActiveConfig().id) && (
                            <div className="mb-4 p-4 border rounded-xl bg-yellow-50 border-yellow-200 text-center">
                                <div className="text-md font-semibold text-yellow-800 mb-2">{subActive} ke liye sheet configure nahi hai.</div>
                                <div className="text-sm text-yellow-700 mb-3">Please paste Google Sheet URL or ID.</div>
                                <form onSubmit={(e) => { e.preventDefault(); const id = parseSheetIdFromUrl(sheetInput); if(id) setOverrides(p => ({...p, [subActive]: id})); setSheetInput(''); }} className="flex gap-2 justify-center">
                                    <input value={sheetInput} onChange={(e) => setSheetInput(e.target.value)} placeholder="Google Sheet URL or Sheet ID" className="flex-1 max-w-md px-3 py-2 border rounded-lg focus:ring-sky-500"/>
                                    <button type="submit" className="px-4 py-2 rounded-lg bg-sky-600 text-white font-medium">Set Sheet</button>
                                </form>
                                {error && <div className="text-sm text-rose-600 mt-2">Error: {error}</div>}
                            </div>
                        )}
                        {error && isValidSheetId(getActiveConfig().id) && <div className="text-sm text-rose-600 mb-4 p-2 border border-rose-300 bg-rose-50 rounded-lg">Error: {error}</div>}
                        <div className={`relative ${showFullScreenLoader ? 'opacity-50 pointer-events-none' : ''}`}>
                            <div className="hidden md:block">
                                <div className={`grid ${isSimpleView ? 'grid-cols-8' : 'grid-cols-10'} items-center px-3 py-2 border-b text-sm font-semibold text-gray-600 bg-gray-50 rounded-t-lg`}>
                                    <div className="col-span-1">Rank</div>
                                    {!isSimpleView && <div className="col-span-3">{nameLabel}</div>}
                                    <div className={`${isSimpleView ? 'col-span-5' : 'col-span-4'} text-center`}>{categoryLabel}</div>
                                    <div className="col-span-2 text-right">Aage Badhne Ke Liye Unit Ki Hajat</div>
                                </div>
                                <div className="space-y-1 mt-1">
                                    {data.items.map((it, idx) => {
                                        const styleClass = idx === 0 ? "bg-amber-50 border-amber-200 shadow-md" : idx === 1 ? "bg-gray-50 border-gray-200" : idx === 2 ? "bg-orange-50 border-orange-200" : "bg-white border-transparent hover:bg-gray-50";
                                        
                                        const diffAhead = idx > 0 ? data.items[idx - 1].__value - it.__value : null;
                                        
                                        const formatDiff = (diff) => {
                                            if (diff === null) return null;
                                            let unitDiff;
                                            if (currentViewConfig.valueIsUnit) {
                                                unitDiff = diff;
                                            } else {
                                                unitDiff = diff / UNIT_DIVISOR;
                                            }
                                            if (unitDiff > -0.05 && unitDiff < 0.05) return "0.1"; // Show 0.1 if very close
                                            return unitDiff.toFixed(1);
                                        }

                                        const formattedDiffAhead = formatDiff(diffAhead);

                                        return (
                                            <div key={it.__id} className={`grid ${isSimpleView ? 'grid-cols-8' : 'grid-cols-10'} items-center gap-4 p-3 rounded-lg transition-all duration-600 ${styleClass} ${it.__id === highlightKey ? "highlight-pulse" : ""}`}>
                                                <div className="col-span-1 font-bold text-lg text-gray-800">{idx + 1}</div>
                                                {!isSimpleView && (
                                                    <div className="col-span-3 text-left text-sm">
                                                        <p className="font-bold text-gray-700 truncate">{it.name || "-"}</p>
                                                    </div>
                                                )}
                                                <div className={`text-center font-bold text-gray-800 ${idx === 0 ? 'text-xl' : 'text-lg'} ${isSimpleView ? 'col-span-5' : 'col-span-4'}`}><span className="inline-flex items-center gap-2">{medalForIndex(idx)}<span>{it.category}</span></span></div>
                                                <div className="col-span-2 text-right">
                                                    {formattedDiffAhead !== null && parseFloat(formattedDiffAhead) > 0.0 && (
                                                        <span className="font-['Bebas_Neue'] text-2xl text-blue-600 flex items-center justify-end" title={`Aage Badhne Ke Liye ${formattedDiffAhead} Unit Ki Hajat`}>
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clipRule="evenodd" /></svg>
                                                            {formattedDiffAhead}
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {data.items.length === 0 && !isLoading && isValidSheetId(getActiveConfig().id) && <div className="text-sm text-gray-500 p-3 text-center">No valid rows found.</div>}
                                </div>
                            </div>
                            <div className="md:hidden space-y-3">
                                {data.items.map((it, idx) => {
                                    const diffAhead = idx > 0 ? data.items[idx - 1].__value - it.__value : null;

                                    const formatDiff = (diff) => {
                                        if (diff === null) return null;
                                        let unitDiff;
                                        if (currentViewConfig.valueIsUnit) {
                                            unitDiff = diff;
                                        } else {
                                            unitDiff = diff / UNIT_DIVISOR;
                                        }
                                        if (unitDiff > -0.05 && unitDiff < 0.05) return "0.1";
                                        return unitDiff.toFixed(1);
                                    }

                                    const formattedDiffAhead = formatDiff(diffAhead);
                                    
                                    return (
                                    <div key={it.__id} className={`p-4 rounded-xl shadow-sm border ${idx === 0 ? "bg-amber-50 border-amber-200" : "bg-white border-gray-200"} ${it.__id === highlightKey ? "highlight-pulse" : ""}`}>
                                        <div className="flex items-start justify-between">
                                            <div>
                                                <div className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                                    <span className="text-2xl">{idx + 1}.</span>
                                                    <span className="truncate max-w-[150px] sm:max-w-[200px]">{it.category}</span>
                                                    <span>{medalForIndex(idx)}</span>
                                                </div>
                                                {!isSimpleView && (
                                                <div className="text-sm text-gray-600 mt-1">
                                                    <span className="font-semibold">{nameLabel}:</span> <span className="font-bold">{it.name || "-"}</span>
                                                </div>
                                                )}
                                            </div>
                                            <div className="text-right">
                                                {formattedDiffAhead !== null && parseFloat(formattedDiffAhead) > 0.0 && (
                                                    <div title={`Aage Badhne Ke Liye ${formattedDiffAhead} Unit Ki Hajat`}>
                                                        <span className="font-['Bebas_Neue'] text-3xl text-blue-600">+{formattedDiffAhead}</span>
                                                        <span className="block text-xs text-gray-500 -mt-1 font-semibold">Hajat</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )})}
                                {data.items.length === 0 && !isLoading && isValidSheetId(getActiveConfig().id) && <div className="text-sm text-gray-500 p-3 text-center">No valid rows found.</div>}
                            </div>
                        </div>
                    </div>
                 );
            }

            return (
                <div className="min-h-screen bg-slate-50">
                    
                    <div className="max-w-7xl mx-auto p-4 sm:p-6">
                        <header className="mb-6 text-center">
                            <h1 className="text-6xl sm:text-7xl font-['Bebas_Neue'] bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-indigo-600">
                                TELETHON 2025
                            </h1>
                            <p className="text-lg sm:text-xl font-['Bebas_Neue'] text-gray-500 tracking-widest">Final Big Telethon Day</p>
                            <h2 className="text-2xl sm:text-3xl font-['Bebas_Neue'] text-amber-500 tracking-widest mt-1 sm:mt-0 heading-anim">
                                GREAT GRAND FINAL
                            </h2>
                        </header>

                        <nav className="mb-4">
                            <div className="hidden md:flex flex-wrap gap-2 justify-center">
                                {MAIN_TABS.map((opt) => (
                                    <button
                                        key={opt}
                                        onClick={() => handleMainTabClick(opt)}
                                        className={`px-4 py-2 rounded-full font-bold text-base shadow-sm focus:outline-none transition-all duration-300 transform hover:-translate-y-1 ${ mainActive === opt ? "bg-indigo-600 text-white shadow-lg" : "bg-white text-gray-800 border border-gray-200 hover:bg-gray-100 hover:shadow-md" }`}
                                    >
                                        <span>{opt}</span>
                                    </button>
                                ))}
                            </div>

                            <div className="md:hidden">
                                <select value={mainActive} onChange={(e) => handleMainTabClick(e.target.value)} className="block w-full px-3 py-2 rounded-lg bg-white border border-slate-300 text-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 shadow-sm">
                                    {MAIN_TABS.map((opt) => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>
                        </nav>
                        
                        {TAB_CONFIG[mainActive].subTabs.length > 0 && (
                             <div className="mb-4 p-2 bg-indigo-50 rounded-xl">
                                <div className="hidden md:flex flex-wrap gap-1 justify-center">
                                    {TAB_CONFIG[mainActive].subTabs.map((opt) => (
                                        <button
                                            key={opt}
                                            onClick={() => setSubActive(opt)}
                                            className={`px-3 py-1.5 rounded-lg font-medium text-xs shadow-sm focus:outline-none transition-colors duration-200 ${ subActive === opt ? "bg-indigo-500 text-white shadow-md" : "bg-white text-gray-700 hover:bg-indigo-100" }`}
                                        >
                                            <span>{opt}</span>
                                        </button>
                                    ))}
                                </div>
                                <div className="md:hidden">
                                     <select value={subActive} onChange={(e) => setSubActive(e.target.value)} className="block w-full px-3 py-2 rounded-lg bg-white border border-slate-300 text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm">
                                        {TAB_CONFIG[mainActive].subTabs.map((opt) => <option key={opt} value={opt}>{opt}</option>)}
                                    </select>
                                </div>
                            </div>
                        )}

                        <div className="flex flex-col items-center justify-center p-3 bg-indigo-100 rounded-xl shadow-sm mb-4 border border-indigo-200">
                            <h2 className="text-2xl font-['Bowlby_One_SC'] text-indigo-800 text-center uppercase">{pageTitle}</h2>
                        </div>

                        <main className="relative">
                            {showFullScreenLoader && (
                                <div className="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex justify-center items-center rounded-lg shadow-xl">
                                    <div className="text-xl text-slate-500 flex flex-col items-center p-8 bg-white border rounded-xl shadow-lg">
                                        <div className="loader w-10 h-10 mb-4 border-t-sky-500 border-4"></div>
                                        Loading...
                                    </div>
                                </div>
                            )}
                            
                            {mainActive === "Jamia Tul Madina Class Wise Rank" && subActive === 'Overall Class Rank' ? (
                                <div className="bg-white border border-gray-200 rounded-xl p-4 shadow-sm relative">
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <h2 className="text-xl md:text-2xl font-bold text-gray-800">All India Classic Rank</h2>
                                        <LiveClock />
                                    </div>
                                    {rankError && <div className="text-sm text-rose-600 mb-4 p-2 border border-rose-300 bg-rose-50 rounded-lg">Error: {rankError}</div>}
                                    <div className="hidden md:grid grid-cols-9 items-center px-3 py-2 border-b text-sm font-semibold text-gray-600 bg-gray-50 rounded-t-lg">
                                        <div className="col-span-1">Rank</div>
                                        <div className="col-span-6">Class Name</div>
                                        <div className="col-span-2 text-right">Aage Badhne Ke Liye Unit Ki Hajat</div>
                                    </div>
                                    <div className="space-y-3 mt-1">
                                        {overallRankData.map((item, idx) => {
                                             const diffAhead = idx > 0 ? overallRankData[idx - 1].totalAmount - item.totalAmount : null;
                                             const formattedDiffAhead = diffAhead !== null ? (diffAhead / UNIT_DIVISOR).toFixed(1) : null;

                                            return (
                                            <div key={item.className} className={`rank-item grid grid-cols-9 items-center p-3 md:p-4 rounded-xl shadow-sm border ${idx === 0 ? "bg-amber-50 border-amber-300 shadow-md" : "bg-white border-gray-200 hover:shadow-md"}`}>
                                                <div className="col-span-1 text-base md:text-2xl font-['Bebas_Neue'] text-center text-gray-800">{idx + 1}</div>
                                                <div className="col-span-6 md:ml-4 flex-grow truncate">
                                                    <div className={`text-base md:text-lg font-bold ${idx === 0 ? "text-amber-700" : "text-gray-800"}`}>
                                                        {item.className}
                                                        <span className="ml-1 text-lg md:text-2xl">{medalForIndex(idx)}</span>
                                                    </div>
                                                    {item.error && <div className="text-xs text-rose-500 mt-1">Error: {item.error}</div>}
                                                </div>
                                                <div className="col-span-2 text-right">
                                                    {formattedDiffAhead !== null && parseFloat(formattedDiffAhead) > 0.0 && (
                                                        <span className="font-['Bebas_Neue'] text-2xl text-blue-600 flex items-center justify-end" title={`Aage Badhne Ke Liye ${formattedDiffAhead} Unit Ki Hajat`}>
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clipRule="evenodd" /></svg>
                                                            {formattedDiffAhead}
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        )})}
                                        {overallRankData.length === 0 && !isRankLoading && <div className="text-center p-4 text-gray-500">No data available.</div>}
                                    </div>
                                </div>
                            ) : (
                               <RankingsView />
                            )}
                        </main>

                        <footer className="mt-8 text-xs text-gray-500 text-center">Made with ‚ù§Ô∏è ‚Äî Majlis Talimi Umoor India</footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><TelethoneEnhancedLive /></React.StrictMode>);
    </script>

</body>
</html>

